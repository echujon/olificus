<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Content Manager</title>
    <style>
        .preview-image-container {
            text-align: center;
            margin-bottom: 2rem;
        }
        .preview-image-container img {
            max-width: 100%;
            height: auto;
            display: inline-block;
            object-fit: contain;
        }
        .preview-caption {
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: #666;
            text-align: center;
        }
    </style>
</head>

<body>
    <script src="https://unpkg.com/decap-cms@latest/dist/decap-cms.js"></script>
    <script>
        // Custom preview template
        var PostPreview = createClass({
            render: function() {
                var entry = this.props.entry;
                var title = entry.getIn(['data', 'title']);
                var images = entry.getIn(['data', 'images']);
                var widgetFor = this.props.widgetFor;
                var h = this.props.h || window.h;

                var elements = [];

                // Title
                elements.push(h('h1', {}, title));

                // Images with captions
                if (images && images.size > 0) {
                    images.forEach(function(image, index) {
                        var imgSrc = image.get('image');
                        var imgAlt = image.get('alt') || '';
                        var caption = image.get('caption');

                        var imgChildren = [h('img', { src: imgSrc, alt: imgAlt })];
                        if (caption) {
                            imgChildren.push(h('div', { className: 'preview-caption' }, caption));
                        }

                        elements.push(
                            h('div', { key: 'img-' + index, className: 'preview-image-container' }, imgChildren)
                        );
                    });
                }

                // Body content - use widgetFor to render markdown
                if (widgetFor && entry.getIn(['data', 'body'])) {
                    elements.push(h('div', { key: 'body' }, widgetFor('body')));
                }

                return h('div', {}, elements);
            }
        });

        CMS.registerPreviewTemplate('comic', PostPreview);

        // Register editor component for image with caption
        CMS.registerEditorComponent({
            id: "image-with-caption",
            label: "Image with Caption",
            fields: [
                {
                    name: "image",
                    label: "Image",
                    widget: "image"
                },
                {
                    name: "alt",
                    label: "Alt Text",
                    widget: "string",
                    required: false
                },
                {
                    name: "caption",
                    label: "Caption",
                    widget: "text",
                    required: false
                }
            ],
            pattern: /<figure>\s*<img src="([^"]+)" alt="([^"]*)">\s*<figcaption>(.*?)<\/figcaption>\s*<\/figure>/,
            fromBlock: function(match) {
                return {
                    image: match[1],
                    alt: match[2] || '',
                    caption: match[3] || ''
                };
            },
            toBlock: function(obj) {
                var html = '<figure>\n';
                html += '  <img src="' + obj.image + '" alt="' + (obj.alt || '') + '">\n';
                if (obj.caption) {
                    html += '  <figcaption>' + obj.caption + '</figcaption>\n';
                }
                html += '</figure>';
                return html;
            },
            toPreview: function(obj) {
                var html = '<figure style="text-align: center; margin: 2rem 0;">';
                html += '<img src="' + obj.image + '" alt="' + (obj.alt || '') + '" style="max-width: 100%; height: auto;">';
                if (obj.caption) {
                    html += '<figcaption style="margin-top: 0.5rem; font-size: 0.9rem; color: #666;">' + obj.caption + '</figcaption>';
                }
                html += '</figure>';
                return html;
            }
        });
    </script>
</body>

</html>
<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Content Manager</title>
    <style>
        .preview-image-container {
            text-align: center;
            margin-bottom: 2rem;
        }
        .preview-image-container img {
            max-width: 100%;
            height: auto;
            display: inline-block;
            object-fit: contain;
        }
        .preview-caption {
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: #666;
            text-align: center;
        }
    </style>
</head>

<body>
    <script src="https://unpkg.com/decap-cms@latest/dist/decap-cms.js"></script>
    <script>
        // Custom preview template
        var PostPreview = createClass({
            render: function() {
                var entry = this.props.entry;
                var title = entry.getIn(['data', 'title']);
                var images = entry.getIn(['data', 'images']);
                var widgetFor = this.props.widgetFor;
                var h = this.props.h || window.h;

                var elements = [];

                // Title
                elements.push(h('h1', {}, title));

                // Images with captions
                if (images && images.size > 0) {
                    images.forEach(function(image, index) {
                        var imgSrc = image.get('image');
                        var imgAlt = image.get('alt') || '';
                        var caption = image.get('caption');

                        var imgChildren = [h('img', { src: imgSrc, alt: imgAlt })];
                        if (caption) {
                            imgChildren.push(h('div', { className: 'preview-caption' }, caption));
                        }

                        elements.push(
                            h('div', { key: 'img-' + index, className: 'preview-image-container' }, imgChildren)
                        );
                    });
                }

                // Body content - use widgetFor to render markdown
                if (widgetFor && entry.getIn(['data', 'body'])) {
                    elements.push(h('div', { key: 'body' }, widgetFor('body')));
                }

                return h('div', {}, elements);
            }
        });

        CMS.registerPreviewTemplate('comic', PostPreview);

        // Register editor component for image with caption
        CMS.registerEditorComponent({
            id: "image-with-caption",
            label: "Image with Caption",
            fields: [
                {
                    name: "image",
                    label: "Image",
                    widget: "image"
                },
                {
                    name: "alt",
                    label: "Alt Text",
                    widget: "string",
                    required: false
                },
                {
                    name: "caption",
                    label: "Caption",
                    widget: "text",
                    required: false
                },
                {
                    name: "caption_font",
                    label: "Caption Font",
                    widget: "select",
                    required: false,
                    default: "Comic Neue",
                    options: [
                        { label: "Comic Neue (Default)", value: "Comic Neue" },
                        { label: "Arial", value: "Arial" },
                        { label: "Times New Roman", value: "Times New Roman" },
                        { label: "Georgia", value: "Georgia" },
                        { label: "Courier New", value: "Courier New" },
                        { label: "Verdana", value: "Verdana" },
                        { label: "Impact", value: "Impact" }
                    ]
                }
            ],
            pattern: /<figure(?:\s+data-font="([^"]*)")?>\s*<img src="([^"]+)" alt="([^"]*)">\s*(?:<figcaption>(.*?)<\/figcaption>)?\s*<\/figure>/,
            fromBlock: function(match) {
                return {
                    caption_font: match[1] || 'Comic Neue',
                    image: match[2],
                    alt: match[3] || '',
                    caption: match[4] || ''
                };
            },
            toBlock: function(obj) {
                var html = '<figure';
                if (obj.caption_font && obj.caption_font !== 'Comic Neue') {
                    html += ' data-font="' + obj.caption_font + '"';
                }
                html += '>\n';
                html += '  <img src="' + obj.image + '" alt="' + (obj.alt || '') + '">\n';
                if (obj.caption) {
                    var fontStyle = '';
                    if (obj.caption_font) {
                        fontStyle = ' style="font-family: \'' + obj.caption_font + '\', system-ui, -apple-system, sans-serif;"';
                    }
                    html += '  <figcaption' + fontStyle + '>' + obj.caption + '</figcaption>\n';
                }
                html += '</figure>';
                return html;
            },
            toPreview: function(obj) {
                var html = '<figure style="text-align: center; margin: 2rem 0;">';
                html += '<img src="' + obj.image + '" alt="' + (obj.alt || '') + '" style="max-width: 100%; height: auto;">';
                if (obj.caption) {
                    var fontFamily = obj.caption_font ? obj.caption_font : 'Comic Neue';
                    html += '<figcaption style="margin-top: 0.5rem; font-size: 1.5rem; font-weight: bold; color: #141313; font-family: \'' + fontFamily + '\', system-ui, -apple-system, sans-serif;">' + obj.caption + '</figcaption>';
                }
                html += '</figure>';
                return html;
            }
        });
    </script>
</body>

</html>
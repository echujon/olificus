name: Purge Cloudflare Cache on Deploy

on:
  # Trigger when pushing to main branch (after CMS commits)
  push:
    branches:
      - main
    paths:
      - 'comic/**'
      - '_includes/**'
      - 'images/**'
      - 'admin/**'
      - '*.js'
      - '*.json'
      - '_site/**'

jobs:
  purge-cache:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get changed files
        id: changed-files
        run: |
          # Get list of changed comic files and extract their slugs from frontmatter
          COMIC_URLS=""
          for file in $(git diff --name-only HEAD~1 HEAD | grep '^comic/.*\.md$' || true); do
            if [ -f "$file" ]; then
              # Extract slug from frontmatter using grep and awk
              SLUG=$(grep -m 1 '^slug:' "$file" | awk '{print $2}' | tr -d '"' | tr -d "'" || true)
              if [ -n "$SLUG" ]; then
                COMIC_URLS="${COMIC_URLS}https://olificus.com/$SLUG/"$'\n'
              fi
            fi
          done

          # Get list of changed images
          IMAGE_URLS=$(git diff --name-only HEAD~1 HEAD | grep '^images/' | sed 's|^|https://olificus.com/|' || true)

          # Combine all URLs and format as JSON array
          ALL_URLS=$(printf "%s\n%s" "$COMIC_URLS" "$IMAGE_URLS" | grep -v '^$' | jq -Rs 'split("\n") | map(select(length > 0))')

          echo "urls=$ALL_URLS" >> $GITHUB_OUTPUT
          echo "Changed URLs: $ALL_URLS"

      - name: Wait for Cloudflare Pages deployment
        run: sleep 30

      - name: Purge specific URLs from Cloudflare Cache
        if: steps.changed-files.outputs.urls != '[]'
        run: |
          curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/purge_cache" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data "{\"files\": ${{ steps.changed-files.outputs.urls }}}"

      - name: Purge home page if includes changed
        if: contains(github.event.head_commit.modified, '_includes/')
        run: |
          curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/purge_cache" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data '{"files": ["https://olificus.com/"]}'
